# AI 통화 리뷰 리포트 — Call ID: ZDKCSe5tPx

**통화 시각:** 2026-02-21 04:44:10 ~ 04:46:04+ (로그 기준)  
**발신:** 1003 → **착신:** 1004 (기상청)  
**트리거:** 무응답 10초 후 AI 인수 (no_answer_timeout)

---

## 1. 통화 요약

| 구간 | 시각 | 내용 |
|------|------|------|
| INVITE | 04:44:10 | 1003→1004 발신, RTP·녹음 시작 |
| 180 Ringing | 04:44:10 | 착신 측 벨 울림 |
| **AI 인수** | **04:44:20** | 10초 무응답 → CANCEL to callee, 200 OK to caller, Pipecat 기동 |
| 파이프라인 구축 | 04:44:20 | 약 0.65초 (LangGraph, SmartTurn, StreamingTTS, Google TTS 등) |
| 인사말 Phase1 | 04:44:20~21 | "안녕하세요. 기상청입니다. 날씨와 관련된 문의를 도와드리겠습니다." |
| 인사말 Phase2 | 04:44:28~30 | "저는 날씨 예보 조회, 기상 특보 안내, … 어떤 것이 궁금하신가요?" |
| 사용자 1차 발화 | 04:45:00 | "어 저는 날씨 예보를 조회하고 싶어요. 날씨 정보에 대해서." |
| AI 1차 응답 | 04:45:10 | 날씨 예보·웹사이트(www.kma.go.kr) 안내 (129자) |
| 사용자 2차 발화 | 04:45:56 | "기상청에 찾아가는 길이 궁금해요." |
| AI 2차 응답 | 04:46:03 | "기상청에 찾아오시는 길은 제가 직접 안내해 드리기 어렵습니다" (33자) |
| 로그 종료 | 04:46:04 | 통화 종료(BYE) 로그 없음 — 이후 계속 진행 추정 |

---

## 2. 문제사항 점검

### 2.1 TTS → RTP 전송량 불일치 (우선 조치 필요)

**증상:** `tts_duration_known`(TTS 합성 길이)과 `tts_rtp_sent_for_response`(실제 RTP 전송량) 차이가 큼.

| 시점 | TTS 재생 길이 | RTP 전송 길이 | 불일치 비율 |
|------|----------------|----------------|-------------|
| 인사말 Phase2 | 20.89초 | 14.32초 | **31.5%** |
| 1차 응답 (날씨 예보) | **43.99초** | **3.64초** | **91.7%** |
| 2차 응답 (오시는 길) | **72.72초** | **4.94초** | **93.2%** |

**해석:**

- 1·2차 응답에서 **대부분 구간이 RTP로 나가지 않은 것처럼** 집계됨.
- 사용자는 **전체 문장이 아니라 앞부분만** 들었을 가능성이 큼 (이전에 적용한 RTP 20ms 패이싱이 이 로그 이후 반영되었는지 확인 필요).
- `tts_duration_known` 43초/72초는 **누적 또는 Notifier 측 집계**일 수 있음.  
  → 턴 단위로 리셋되는지, 응답별 `bytes_sent`/`duration_sec` 정의 재검토 권장.

**권장 조치:**

1. RTP 실시간 패이싱(20ms 간격) 적용 여부 확인 및 유지.
2. `SIPPBXOutputTransport`에서 턴(또는 응답) 단위 `_response_bytes` 리셋 시점과 Notifier `duration_sec` 집계 범위 정합성 점검.
3. 동일 조건에서 재현 테스트 후 `tts_rtp_duration_mismatch` 경고 감소 여부 확인.

---

### 2.2 두 번째 질의에 대한 답변 품질 (RAG/지식 부족)

**사용자:** "기상청에 찾아가는 길이 궁금해요."

**RAG 검색:**

- query: "기상청 찾아가는 방법" (rewrite 정상)
- results_count: 2
- top_doc_preview: **"과거 기상 관측 데이터 조회 및 자료 신청 방법을 안내합니다."**

**AI 응답:** "기상청에 찾아오시는 길은 제가 직접 안내해 드리기 어렵습니다"

**문제:**

- “오시는 길” 질의인데, 검색된 상위 문서는 **과거 기상 데이터 조회** 안내.
- 지식베이스에 **기상청 오시는 길/교통/위치** 문서가 없거나 유사도가 낮아 검색에서 빠진 것으로 보임.
- 그 결과 LLM이 “직접 안내 어렵다”는 회피형 답변만 생성.

**권장 조치:**

1. 기상청(1004) 테넌트 지식베이스에 **오시는 길, 대중교통, 주소, 약도** 등 문서 추가.
2. RAG top_k·threshold 또는 rewrite 프롬프트로 “찾아가는 길/오시는 길/위치” 쿼리 보강.
3. “안내 어렵다”만 반복될 때 **웹/외부 검색 또는 HITL 전환** 정책 검토.

---

### 2.3 DB 로깅 미설정 (경미)

- `DB client not configured, skipping RAG logging` / `skipping knowledge match logging` 발생.
- RAG·LLM·지식 매칭 이벤트가 DB에 남지 않음 (이미 1회 경고로 정리된 상태).
- 분석·품질 개선을 위해 DB 로깅 사용 시, 앱 기동 시 `ai_logger.set_db_client(db)` 호출 권장.

---

### 2.4 기타 (정상 동작)

- **AI 인수:** no_answer 10초 후 CANCEL → 200 OK → Pipecat 기동 정상.
- **STT:** 사용자 발화 2회 모두 final 전사 수신 (33자, 18자).
- **의도 분류:** 두 턴 모두 `question`, LangGraph 플로우 정상.
- **인사말 Phase1:** TTS 6.04초 vs RTP 5.84초로 거의 일치 (Phase1은 이상 없음).
- **WebSocket:** `ws_stt_transcript_sent`, `ws_call_subscribed` 등 대시보드 연동 이벤트 정상 기록.

---

## 3. 요약 및 우선순위

| 우선순위 | 항목 | 조치 |
|----------|------|------|
| **P0** | TTS–RTP 불일치 (91.7%, 93.2%) | RTP 패이싱·응답 단위 집계 검증; 재현 테스트로 경고 감소 확인 |
| **P1** | “오시는 길” 답변 품질 | 지식베이스에 오시는 길 문서 추가; RAG/rewrite로 쿼리 보강 |
| **P2** | DB 로깅 | 필요 시 `set_db_client` 설정으로 RAG/지식 로그 적재 |

---

## 4. 로그 근거 (발췌)

- `no_answer_timeout_activating_ai` @ 04:44:20.163
- `pipecat_pipeline_built` @ 04:44:20.819, build_elapsed 0.653s
- `tts_rtp_duration_mismatch` @ 04:44:30.326 (31.5%), @ 04:45:11.410 (91.7%), @ 04:46:04.490 (93.2%)
- `rag_search_completed` for "기상청 찾아가는 방법" → top_doc "과거 기상 관측 데이터 조회..."
- `llm_exchange_full` response_full "기상청에 찾아오시는 길은 제가 직접 안내해 드리기 어렵습니다"
