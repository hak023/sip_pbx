# 마지막 AI 통화 STT 디버깅 (YCYrz6cVN4)

- **통화 시각**: 2026-02-21 03:25:00 ~ 03:25:54 (AI 응대)
- **로그**: `logs/app.log` 해당 구간

---

## 1. 실시간 STT (통화 중)

### 1.1 동작 요약

| 시각 | 이벤트 | 내용 |
|------|--------|------|
| 03:25:37 ~ 03:25:42 | ws_stt_transcript_sent (interim) | text_len 3~34, 여러 번 발송 |
| 03:25:42.691 | **rag_llm_user_input** | "안녕하세요 주차 문의하려고 하는데요 주차는 어떻게 해야 돼요?" (34자) — **최종 인식 1회** |
| 03:25:42.693 | ws_stt_transcript_sent (final) | text_len 34 |
| 03:25:50 ~ 03:25:51 | LLM 응답 → TTS 재생 | 사용자 질문에 대한 AI 응답 재생 |
| 03:25:54 | BYE | 통화 종료 |
| 03:26:04 | **409 Stream timed out** | Pipecat: "Stream timed out after receiving no more client requests" |

### 1.2 판단

- **실시간 STT는 한 턴만 처리됨**: 사용자 발화 1회가 `TranscriptionFrame`(final)으로 RAG/LLM까지 전달되었고, 그에 대한 AI 응답까지 정상 처리됨.
- **409 타임아웃**: BYE 이후 더 이상 오디오가 전달되지 않아 Google STT 스트림이 타임아웃된 것으로 보이며, **통화 종료 후 정상적인 종료 동작**으로 해석 가능.
- 사용자가 AI 응답 **이후**에 추가로 말했는데 인식이 안 됐다면 가능 원인:
  - TTS 재생 구간에서 **실시간 STT 스트림이 유지되지 않거나** (스트림 유휴 타임아웃),
  - **VAD**가 두 번째 발화를 “침묵”으로 잘라서 final이 안 나왔을 수 있음.

### 1.3 추가 디버깅 제안

- 실시간 STT: **세션별**로 `TranscriptionFrame`(final) 수를 로그에 남기면, “한 턴만 나온다” vs “여러 턴 나오는데 일부만 LLM까지 전달된다”를 구분하기 쉬움.
- 409 발생 시점(통화 종료 직후 vs 통화 중)을 구분해 로그에 남기면, “통화 중 스트림 끊김” 여부 확인에 유리함.

---

## 2. 후처리 STT (녹음 → transcript.txt)

### 2.1 로그 요약

- **녹음**: caller_frames 2191, callee_frames 1041 → caller.wav(43.82초), callee.wav(20.76초).
- **STT 결과**: caller **11 words**, callee **58 words** (speaker 1=caller, 2=callee).
- **transcript preview**:  
  `착신자: ▁안녕하세요 ▁기 상 청 ▁ai ▁통화 ▁비 서 입니다 ...`  
  → **발신자(사람) 11단어**, **착신자(AI) 58단어**로 저장됨.

### 2.2 “STT가 제대로 안 나간다”로 보일 수 있는 점

1. **transcript에 ▁(서브워드) 노출**  
   - Google STT word-level 결과에 **▁(U+2581)** 가 포함되어, 문장이 **“▁안녕하세요 ▁기 상 청 …”** 처럼 끊겨 보임.  
   - **조치**: 저장 시 **▁ 제거** 후 저장하도록 `_format_transcript_with_speakers`에서 단어 정규화 적용함 → 다음 통화부터는 읽기 쉬운 문장으로 저장됨.

2. **caller 11 words**  
   - 실제 통화에서 사용자가 말한 **“안녕하세요 주차 문의하려고 하는데요 주차는 어떻게 해야 돼요?”** 한 문장과 단어 수가 맞음.  
   - 즉, **실제로 말한 양에 비해 후처리 STT가 비정상적으로 적게 나온 것은 아님**.

---

## 3. 적용한 수정

| 항목 | 파일 | 내용 |
|------|------|------|
| transcript 가독성 | `sip_call_recorder.py` | `_format_transcript_with_speakers`에서 단어 저장 시 **▁(U+2581) 제거** 후 사용. 빈 단어는 라인에 넣지 않음. |

---

## 4. 요약

- **실시간 STT**: 한 턴(사용자 질문 1회 → AI 응답 1회)은 정상 동작. 409는 BYE 이후 스트림 종료로 보는 것이 타당.
- **후처리 STT**: 발신 11단어/착신 58단어는 통화 내용과 부합. 다만 **transcript.txt에 ▁가 그대로 나오던 문제**는 위 정규화로 보정됨.
- 추가로 “두 번째 발화가 안 나온다” 등을 보려면, 실시간 구간에서 **final 전사 건수/시각** 로그를 남기는 것이 좋음.
