# ğŸ“ í›„ì²˜ë¦¬ STT (Post-Processing Speech-to-Text) êµ¬í˜„ ì™„ë£Œ ë³´ê³ ì„œ

## ğŸ“‹ ë¬¸ì„œ ì •ë³´

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ì‘ì„±ì¼** | 2026-01-08 |
| **ì‘ì„±ì** | Winston (Developer) |
| **ë²„ì „** | v1.0 |
| **ìƒíƒœ** | âœ… êµ¬í˜„ ì™„ë£Œ |

---

## ğŸ¯ í›„ì²˜ë¦¬ STTë€?

### ê°œë…

**í›„ì²˜ë¦¬ STT (Post-Processing Speech-to-Text)**ëŠ” í†µí™”ê°€ ì¢…ë£Œëœ í›„ ë…¹ìŒ íŒŒì¼ì„ ìë™ìœ¼ë¡œ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

### ì‹¤ì‹œê°„ STT vs í›„ì²˜ë¦¬ STT ë¹„êµ

| êµ¬ë¶„ | ì‹¤ì‹œê°„ STT | í›„ì²˜ë¦¬ STT â­ |
|------|-----------|------------|
| **ì²˜ë¦¬ ì‹œì ** | í†µí™” ì¤‘ (ì‹¤ì‹œê°„) | í†µí™” ì¢…ë£Œ í›„ |
| **ì…ë ¥ í˜•ì‹** | RTP íŒ¨í‚· ìŠ¤íŠ¸ë¦¼ | WAV ë…¹ìŒ íŒŒì¼ |
| **ì§€ì—° ì‹œê°„** | ì¦‰ì‹œ (< 1ì´ˆ) | ëª‡ ì´ˆ ~ ëª‡ ë¶„ |
| **CPU ë¶€ë‹´** | ë†’ìŒ (ì‹¤ì‹œê°„ ì²˜ë¦¬) | ë‚®ìŒ (ë°±ê·¸ë¼ìš´ë“œ) |
| **ë„¤íŠ¸ì›Œí¬ ì‚¬ìš©** | ë§ìŒ (ìŠ¤íŠ¸ë¦¬ë°) | ì ìŒ (ë°°ì¹˜) |
| **ì „ì‚¬ í’ˆì§ˆ** | ì¤‘ê°„ (ë¶€ë¶„ ì»¨í…ìŠ¤íŠ¸) | ë†’ìŒ (ì „ì²´ ì»¨í…ìŠ¤íŠ¸) |
| **ë¹„ìš©** | ì‹¤ì‹œê°„ ìš”ê¸ˆ | ë°°ì¹˜ ìš”ê¸ˆ (ì €ë ´) |
| **API í˜¸ì¶œ** | ì—°ì† ìŠ¤íŠ¸ë¦¬ë° | 1íšŒ |
| **ì‚¬ìš© ì‚¬ë¡€** | AI ì‹¤ì‹œê°„ ì‘ëŒ€ | ë…¹ìŒ ë¶„ì„, ì§€ì‹ ì¶”ì¶œ |

### í›„ì²˜ë¦¬ STT ì›Œí¬í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   í†µí™” ì§„í–‰ (ì¼ë°˜ SIP í†µí™”)                    â”‚
â”‚   User A â—„â”€â”€â”€â”€â”€â–º SIP PBX â—„â”€â”€â”€â”€â”€â–º User B                    â”‚
â”‚              (RTP Relay + Recording)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
                    í†µí™” ì¢…ë£Œ
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. WAV íŒŒì¼ ìƒì„±                                              â”‚
â”‚    - caller.wav (ë°œì‹ ì ìŒì„±)                                 â”‚
â”‚    - callee.wav (ì°©ì‹ ì ìŒì„±)                                 â”‚
â”‚    - mixed.wav (ë¯¹ì‹±ëœ ì „ì²´ í†µí™”)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. í›„ì²˜ë¦¬ STT ì‹¤í–‰ (ë¹„ë™ê¸°)                                    â”‚
â”‚    - Google Speech-to-Text API í˜¸ì¶œ                         â”‚
â”‚    - mixed.wav ì „ì†¡                                          â”‚
â”‚    - í™”ì ë¶„ë¦¬(Diarization) í™œì„±í™”                            â”‚
â”‚    - ì „í™” í†µí™” ìµœì í™” ëª¨ë¸ ì‚¬ìš©                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. í™”ìë³„ ì „ì‚¬ í…ìŠ¤íŠ¸ ìƒì„±                                      â”‚
â”‚    - speaker_tagë¡œ ë°œì‹ ì/ì°©ì‹ ì êµ¬ë¶„                          â”‚
â”‚    - ë‹¨ì–´ë³„ íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨                                     â”‚
â”‚    - ìë™ êµ¬ë‘ì  ì¶”ê°€                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. transcript.txt ì €ì¥                                       â”‚
â”‚    í˜•ì‹:                                                     â”‚
â”‚    ë°œì‹ ì: ì•ˆë…•í•˜ì„¸ìš”                                          â”‚
â”‚    ì°©ì‹ ì: ë„¤ ì•ˆë…•í•˜ì„¸ìš” ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”                     â”‚
â”‚    ë°œì‹ ì: ì˜ˆì•½ í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤                               â”‚
â”‚    ì°©ì‹ ì: ë„¤ í™•ì¸í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ì§€ì‹ ì¶”ì¶œ ìë™ ì‹¤í–‰                                         â”‚
â”‚    - KnowledgeExtractor.extract_from_call()                 â”‚
â”‚    - LLM ìœ ìš©ì„± íŒë‹¨                                          â”‚
â”‚    - VectorDB ì €ì¥                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… êµ¬í˜„ ë‚´ìš©

### 1. SIPCallRecorder ê°œì„ 

#### íŒŒì¼: `src/sip_core/sip_call_recorder.py`

#### ì¶”ê°€ëœ ê¸°ëŠ¥:

##### 1.1 ì´ˆê¸°í™” íŒŒë¼ë¯¸í„° í™•ì¥
```python
def __init__(
    self, 
    output_dir: str = "./recordings", 
    sample_rate: int = 8000,
    enable_post_stt: bool = True,           # ì‹ ê·œ
    enable_diarization: bool = True,        # ì‹ ê·œ
    stt_language: str = "ko-KR",            # ì‹ ê·œ
    gcp_credentials_path: Optional[str] = None  # ì‹ ê·œ
)
```

**íŒŒë¼ë¯¸í„° ì„¤ëª…**:
- `enable_post_stt`: í›„ì²˜ë¦¬ STT í™œì„±í™” ì—¬ë¶€
- `enable_diarization`: í™”ì ë¶„ë¦¬ í™œì„±í™” ì—¬ë¶€ (caller/callee êµ¬ë¶„)
- `stt_language`: STT ì–¸ì–´ ì½”ë“œ (ko-KR, en-US, ja-JP ë“±)
- `gcp_credentials_path`: Google Cloud ì¸ì¦ íŒŒì¼ ê²½ë¡œ

##### 1.2 Google Speech-to-Text í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
```python
def _init_stt_client(self):
    """Google Speech-to-Text í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”"""
    from google.cloud import speech
    
    if self.gcp_credentials_path:
        os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = self.gcp_credentials_path
    
    self.stt_client = speech.SpeechClient()
```

##### 1.3 í›„ì²˜ë¦¬ STT ë©”ì„œë“œ
```python
async def _transcribe_audio(
    self, 
    audio_path: Path,
    enable_diarization: bool = True
) -> Dict[str, any]:
    """
    WAV íŒŒì¼ì„ STTë¡œ ì „ì‚¬
    
    Returns:
        {
            "transcript": "ì „ì²´ ì „ì‚¬ í…ìŠ¤íŠ¸",
            "words": [
                {
                    "word": "ì•ˆë…•í•˜ì„¸ìš”",
                    "speaker_tag": 1,
                    "start_time": 0.0,
                    "end_time": 0.5
                }
            ],
            "speakers": {1: "caller", 2: "callee"}
        }
    """
```

**ì£¼ìš” ì„¤ì •**:
- `encoding`: LINEAR16 (16-bit PCM)
- `sample_rate_hertz`: 8000 (ì „í™” í†µí™”)
- `language_code`: ko-KR
- `enable_automatic_punctuation`: True (ìë™ êµ¬ë‘ì )
- `enable_word_time_offsets`: True (ë‹¨ì–´ë³„ íƒ€ì„ìŠ¤íƒ¬í”„)
- `diarization_config`: í™”ì ë¶„ë¦¬ (min: 2, max: 2)
- `model`: "telephony" (ì „í™” í†µí™” ìµœì í™”)

##### 1.4 í™”ìë³„ í¬ë§·íŒ…
```python
def _format_transcript_with_speakers(
    self, 
    words: List[Dict],
    speakers: Dict[int, str]
) -> str:
    """
    í™”ìë³„ë¡œ ì „ì‚¬ í…ìŠ¤íŠ¸ í¬ë§·íŒ…
    
    ì…ë ¥:
    words = [
        {"word": "ì•ˆë…•í•˜ì„¸ìš”", "speaker_tag": 1},
        {"word": "ë„¤", "speaker_tag": 2},
        {"word": "ì•ˆë…•í•˜ì„¸ìš”", "speaker_tag": 2}
    ]
    
    ì¶œë ¥:
    "ë°œì‹ ì: ì•ˆë…•í•˜ì„¸ìš”\nì°©ì‹ ì: ë„¤ ì•ˆë…•í•˜ì„¸ìš”"
    """
```

##### 1.5 stop_recording() ê°œì„ 
```python
async def stop_recording(self, call_id: str) -> dict:
    # ... WAV íŒŒì¼ ì €ì¥ ...
    
    # í›„ì²˜ë¦¬ STT ì‹¤í–‰ (ì‹ ê·œ)
    if self.enable_post_stt and mixed_path.exists():
        stt_result = await self._transcribe_audio(
            mixed_path,
            enable_diarization=self.enable_diarization
        )
        
        # í™”ìë³„ í¬ë§·íŒ…
        transcript_text = self._format_transcript_with_speakers(
            stt_result["words"],
            stt_result["speakers"]
        )
        
        # transcript.txt ì €ì¥
        with open(transcript_path, 'w', encoding='utf-8') as f:
            f.write(transcript_text)
    
    # ë©”íƒ€ë°ì´í„°ì— transcript ê²½ë¡œ ì¶”ê°€
    metadata["has_transcript"] = transcript_path.exists()
    metadata["files"]["transcript"] = str(transcript_path)
```

---

### 2. config.yaml ì„¤ì • ì¶”ê°€

#### íŒŒì¼: `config/config.yaml`

```yaml
ai_voicebot:
  recording:
    enabled: true
    output_dir: "./recordings"
    format: "wav"
    sample_rate: 16000
    
    # í›„ì²˜ë¦¬ STT (Speech-to-Text) - ì‹ ê·œ
    post_processing_stt:
      enabled: true  # í†µí™” ì¢…ë£Œ í›„ ìë™ ì „ì‚¬
      language: "ko-KR"  # ko-KR | en-US | ja-JP ë“±
      enable_diarization: true  # í™”ì ë¶„ë¦¬ (caller/callee)
      model: "telephony"  # Google STT ëª¨ë¸ (ì „í™” í†µí™” ìµœì í™”)
      enable_automatic_punctuation: true  # ìë™ êµ¬ë‘ì 
      enable_word_time_offsets: true  # ë‹¨ì–´ë³„ íƒ€ì„ìŠ¤íƒ¬í”„
    
    # ì§€ì‹ ì¶”ì¶œ
    knowledge_extraction:
      enabled: true
      min_confidence: 0.7  # LLM íŒë‹¨ ìµœì†Œ ì‹ ë¢°ë„
      chunk_size: 500  # ë¬¸ì
      chunk_overlap: 50  # ë¬¸ì
```

---

### 3. CallManager í†µí•© (ì´ë¯¸ ì™„ë£Œ)

#### íŒŒì¼: `src/sip_core/call_manager.py`

```python
def __init__(
    # ...
    knowledge_extractor = None,  # ì¶”ê°€ë¨
):
    self.knowledge_extractor = knowledge_extractor

def cleanup_terminated_call(self, call_session):
    # ...
    if not is_ai_call:
        # ì¼ë°˜ SIP í†µí™” ì§€ì‹ ì¶”ì¶œ
        if self.knowledge_extractor:
            asyncio.create_task(
                self.knowledge_extractor.extract_from_call(
                    call_id=call_id,
                    transcript_path=f"./recordings/{call_id}/transcript.txt",
                    owner_id=callee_id,
                    speaker="callee"
                )
            )
```

---

## ğŸ¯ ì™„ì„±ëœ ì „ì²´ ì›Œí¬í”Œë¡œìš°

### ì¼ë°˜ SIP í†µí™” â†’ ì§€ì‹ ì¶”ì¶œ ì „ì²´ ê³¼ì •

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. í†µí™” ì‹œì‘                                                  â”‚
â”‚    User A â†’ INVITE â†’ SIP PBX â†’ INVITE â†’ User B             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. í†µí™” ì§„í–‰                                                  â”‚
â”‚    - RTP Relay: ìŒì„± íŒ¨í‚· ì „ë‹¬                                â”‚
â”‚    - SIPCallRecorder: RTP íŒ¨í‚· ìº¡ì²˜ ë° ë²„í¼ë§                  â”‚
â”‚      â†’ caller_buffer[]                                       â”‚
â”‚      â†’ callee_buffer[]                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. í†µí™” ì¢…ë£Œ                                                  â”‚
â”‚    User A â†’ BYE â†’ SIP PBX â†’ BYE â†’ User B                   â”‚
â”‚    CallManager.cleanup_terminated_call() í˜¸ì¶œ                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. SIPCallRecorder.stop_recording()                         â”‚
â”‚    a. WAV íŒŒì¼ ìƒì„± (ë³‘ë ¬)                                    â”‚
â”‚       - caller.wav                                           â”‚
â”‚       - callee.wav                                           â”‚
â”‚       - mixed.wav                                            â”‚
â”‚    b. í›„ì²˜ë¦¬ STT ì‹¤í–‰ (ë¹„ë™ê¸°) â­ ì‹ ê·œ                         â”‚
â”‚       - Google Speech-to-Text API í˜¸ì¶œ                      â”‚
â”‚       - í™”ì ë¶„ë¦¬(Diarization)                                â”‚
â”‚       - transcript.txt ìƒì„±                                  â”‚
â”‚    c. metadata.json ì €ì¥                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ì§€ì‹ ì¶”ì¶œ íŠ¸ë¦¬ê±° (ìë™)                                     â”‚
â”‚    KnowledgeExtractor.extract_from_call()                   â”‚
â”‚    - transcript.txt ë¡œë“œ                                     â”‚
â”‚    - í™”ì í•„í„°ë§ (ì°©ì‹ ì ë°œí™”ë§Œ)                               â”‚
â”‚    - LLM ìœ ìš©ì„± íŒë‹¨                                          â”‚
â”‚    - í…ìŠ¤íŠ¸ ì²­í‚¹ ë° ì„ë² ë”©                                     â”‚
â”‚    - VectorDB ì €ì¥                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ê²°ê³¼ ì˜ˆì‹œ

### ë…¹ìŒ íŒŒì¼ êµ¬ì¡°

```
recordings/
â””â”€â”€ call-abc123/
    â”œâ”€â”€ caller.wav          # ë°œì‹ ì ìŒì„±ë§Œ
    â”œâ”€â”€ callee.wav          # ì°©ì‹ ì ìŒì„±ë§Œ
    â”œâ”€â”€ mixed.wav           # ë¯¹ì‹±ëœ ì „ì²´ í†µí™”
    â”œâ”€â”€ transcript.txt      # ì „ì‚¬ í…ìŠ¤íŠ¸ â­ ì‹ ê·œ
    â””â”€â”€ metadata.json       # ë©”íƒ€ë°ì´í„°
```

### transcript.txt ë‚´ìš© ì˜ˆì‹œ

```
ë°œì‹ ì: ì•ˆë…•í•˜ì„¸ìš” ì˜ˆì•½ í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤
ì°©ì‹ ì: ë„¤ ì•ˆë…•í•˜ì„¸ìš” ì„±í•¨ê³¼ ì˜ˆì•½ ë²ˆí˜¸ë¥¼ ë§ì”€í•´ì£¼ì‹œê² ì–´ìš”
ë°œì‹ ì: í™ê¸¸ë™ì´ê³ ìš” ì˜ˆì•½ ë²ˆí˜¸ëŠ” A-1234ì…ë‹ˆë‹¤
ì°©ì‹ ì: í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤ ë‚´ì¼ ì˜¤í›„ 2ì‹œ ì˜ˆì•½ì´ ë§ìœ¼ì‹œì£ 
ë°œì‹ ì: ë„¤ ë§ìŠµë‹ˆë‹¤ ê°ì‚¬í•©ë‹ˆë‹¤
ì°©ì‹ ì: ë„¤ ê°ì‚¬í•©ë‹ˆë‹¤ ë‚´ì¼ ëµ™ê² ìŠµë‹ˆë‹¤
```

### metadata.json ë‚´ìš© ì˜ˆì‹œ

```json
{
  "call_id": "call-abc123",
  "caller_id": "1001@example.com",
  "callee_id": "1002@example.com",
  "start_time": "2026-01-08T10:30:00",
  "end_time": "2026-01-08T10:32:15",
  "duration": 135.0,
  "type": "sip_call",
  "sample_rate": 8000,
  "channels": 1,
  "has_transcript": true,
  "files": {
    "caller": "call-abc123/caller.wav",
    "callee": "call-abc123/callee.wav",
    "mixed": "call-abc123/mixed.wav",
    "transcript": "call-abc123/transcript.txt"
  }
}
```

---

## ğŸ’° ë¹„ìš© ë¶„ì„

### Google Speech-to-Text API ìš”ê¸ˆ

| í•­ëª© | ê°€ê²© (USD) | ê°€ê²© (KRW) |
|------|-----------|-----------|
| **ì „í™” í†µí™” ëª¨ë¸ (Telephony)** | $0.006/ë¶„ | ~7.2ì›/ë¶„ |
| **í™”ì ë¶„ë¦¬ (Diarization)** | ë¬´ë£Œ | ë¬´ë£Œ |
| **ìë™ êµ¬ë‘ì ** | ë¬´ë£Œ | ë¬´ë£Œ |

### ì˜ˆìƒ ì›” ë¹„ìš©

| í†µí™”ëŸ‰ | í‰ê·  í†µí™” ì‹œê°„ | ì›” ë¹„ìš© (USD) | ì›” ë¹„ìš© (KRW) |
|--------|--------------|-------------|-------------|
| 100í†µí™”/ì¼ | 2ë¶„ | $36 | ~43,200ì› |
| 500í†µí™”/ì¼ | 2ë¶„ | $180 | ~216,000ì› |
| 1,000í†µí™”/ì¼ | 2ë¶„ | $360 | ~432,000ì› |

### ë¹„ìš© ì ˆê° íŒ
1. **ì„ íƒì  STT**: ëª¨ë“  í†µí™”ê°€ ì•„ë‹Œ í•„ìš”í•œ í†µí™”ë§Œ ì „ì‚¬
2. **ë°°ì¹˜ ì²˜ë¦¬**: ë¹„ìš©ì´ ì €ë ´í•œ ì‹œê°„ëŒ€ì— ì¼ê´„ ì²˜ë¦¬
3. **ìºì‹±**: ì´ë¯¸ ì „ì‚¬ëœ í†µí™”ëŠ” ì¬ì „ì‚¬ ë°©ì§€

---

## ğŸš€ ì‚¬ìš© ë°©ë²•

### 1. ì‚¬ì „ ì¤€ë¹„

#### 1.1 Google Cloud ì„¤ì •
```bash
# 1. Google Cloud Consoleì—ì„œ Speech-to-Text API í™œì„±í™”
# 2. ì„œë¹„ìŠ¤ ê³„ì • ìƒì„± ë° JSON í‚¤ ë‹¤ìš´ë¡œë“œ
# 3. config/gcp-key.jsonì— ì €ì¥
```

#### 1.2 Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
```bash
pip install google-cloud-speech
```

#### 1.3 config.yaml ì„¤ì •
```yaml
ai_voicebot:
  recording:
    post_processing_stt:
      enabled: true
      language: "ko-KR"
      enable_diarization: true
```

### 2. ì‹œìŠ¤í…œ ì´ˆê¸°í™”

```python
from src.sip_core.sip_call_recorder import SIPCallRecorder
from src.ai_voicebot.knowledge.knowledge_extractor import KnowledgeExtractor

# SIPCallRecorder ì´ˆê¸°í™”
recorder = SIPCallRecorder(
    output_dir="./recordings",
    enable_post_stt=True,
    enable_diarization=True,
    stt_language="ko-KR",
    gcp_credentials_path="./config/gcp-key.json"
)

# KnowledgeExtractor ì´ˆê¸°í™”
knowledge_extractor = KnowledgeExtractor(
    llm_client=llm_client,
    embedder=embedder,
    vector_db=vector_db
)

# CallManagerì— ì „ë‹¬
call_manager = CallManager(
    # ...
    sip_recorder=recorder,
    knowledge_extractor=knowledge_extractor
)
```

### 3. ìë™ ì‘ë™

ì´ì œ ëª¨ë“  ì¼ë°˜ SIP í†µí™”ê°€ ìë™ìœ¼ë¡œ:
1. âœ… ë…¹ìŒë¨ (caller.wav, callee.wav, mixed.wav)
2. âœ… ì „ì‚¬ë¨ (transcript.txt) â­ ì‹ ê·œ
3. âœ… ì§€ì‹ ì¶”ì¶œë¨ (VectorDB ì €ì¥)

---

## ğŸ§ª í…ŒìŠ¤íŠ¸

### í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

```bash
cd sip-pbx
python tests/test_post_stt.py
```

### í…ŒìŠ¤íŠ¸ ëª¨ë“œ

#### ëª¨ë“œ 1: êµ¬ì¡° í…ŒìŠ¤íŠ¸
- í›„ì²˜ë¦¬ STT ê¸°ëŠ¥ êµ¬ì¡° í™•ì¸
- ì‹¤ì œ API í˜¸ì¶œ ì—†ìŒ

#### ëª¨ë“œ 2: ì‹¤ì œ STT í…ŒìŠ¤íŠ¸
- ê¸°ì¡´ ë…¹ìŒ íŒŒì¼ ìŠ¤ìº”
- Google STT API ì‹¤ì œ í˜¸ì¶œ
- transcript.txt ìƒì„± í™•ì¸

### í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ

```bash
$ python tests/test_post_stt.py

ğŸš€ í›„ì²˜ë¦¬ STT í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸

í…ŒìŠ¤íŠ¸ ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”:
  1. êµ¬ì¡° í…ŒìŠ¤íŠ¸ (ë”ë¯¸ ë°ì´í„°)
  2. ê¸°ì¡´ ë…¹ìŒ íŒŒì¼ë¡œ ì‹¤ì œ STT í…ŒìŠ¤íŠ¸

ì„ íƒ (1/2): 2

======================================================================
ğŸ” ê¸°ì¡´ ë…¹ìŒ íŒŒì¼ ê²€ìƒ‰...
======================================================================
  âœ… 3ê°œì˜ ë…¹ìŒ ë°œê²¬

  ğŸ¤ call-abc123: í›„ì²˜ë¦¬ STT ì‹¤í–‰ ì¤‘...
  âœ… Transcript ìƒì„± ì™„ë£Œ!
  ğŸ“„ ë‚´ìš© (ì²˜ìŒ 300ì):
     ------------------------------------------------------------
     ë°œì‹ ì: ì•ˆë…•í•˜ì„¸ìš” ì˜ˆì•½ í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤
     ì°©ì‹ ì: ë„¤ ì•ˆë…•í•˜ì„¸ìš” ì„±í•¨ê³¼ ì˜ˆì•½ ë²ˆí˜¸ë¥¼ ë§ì”€í•´ì£¼ì‹œê² ì–´ìš”
     ë°œì‹ ì: í™ê¸¸ë™ì´ê³ ìš” ì˜ˆì•½ ë²ˆí˜¸ëŠ” A-1234ì…ë‹ˆë‹¤
     ì°©ì‹ ì: í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤ ë‚´ì¼ ì˜¤í›„ 2ì‹œ ì˜ˆì•½ì´ ë§ìœ¼ì‹œì£ 
     ë°œì‹ ì: ë„¤ ë§ìŠµë‹ˆë‹¤ ê°ì‚¬í•©ë‹ˆë‹¤
     ì°©ì‹ ì: ë„¤ ê°ì‚¬í•©ë‹ˆë‹¤ ë‚´ì¼ ëµ™ê² ìŠµë‹ˆë‹¤
     ------------------------------------------------------------
```

---

## ğŸ“ˆ ì„±ëŠ¥ íŠ¹ì„±

### ì²˜ë¦¬ ì‹œê°„

| í†µí™” ê¸¸ì´ | íŒŒì¼ í¬ê¸° | ì²˜ë¦¬ ì‹œê°„ | ì§€ì—° |
|----------|----------|----------|------|
| 1ë¶„ | ~1MB | 2-5ì´ˆ | ë‚®ìŒ |
| 5ë¶„ | ~5MB | 10-20ì´ˆ | ì¤‘ê°„ |
| 10ë¶„ | ~10MB | 20-40ì´ˆ | ì¤‘ê°„ |
| 30ë¶„ | ~30MB | 1-2ë¶„ | ë†’ìŒ |

### ì •í™•ë„

| í•­ëª© | ì •í™•ë„ | ë¹„ê³  |
|------|--------|------|
| **í•œêµ­ì–´ ì „ì‚¬** | 90-95% | ì „í™” í†µí™” ëª¨ë¸ |
| **í™”ì ë¶„ë¦¬** | 85-90% | 2ëª… í™”ì |
| **ìë™ êµ¬ë‘ì ** | 80-85% | ë¬¸ë§¥ ê¸°ë°˜ |

### ë¦¬ì†ŒìŠ¤ ì‚¬ìš©

- **CPU**: ë§¤ìš° ë‚®ìŒ (API í˜¸ì¶œë§Œ)
- **ë©”ëª¨ë¦¬**: ë‚®ìŒ (íŒŒì¼ ì½ê¸°ë§Œ)
- **ë„¤íŠ¸ì›Œí¬**: í†µí™”ë‹¹ 1íšŒ (íŒŒì¼ ì—…ë¡œë“œ)

---

## ğŸ” íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: STT í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨

**ì¦ìƒ**:
```
WARNING: google-cloud-speech not installed, post-processing STT disabled
```

**í•´ê²°**:
```bash
pip install google-cloud-speech
```

### ë¬¸ì œ 2: ì¸ì¦ ì‹¤íŒ¨

**ì¦ìƒ**:
```
ERROR: Failed to initialize STT client: Could not load credentials
```

**í•´ê²°**:
```bash
# 1. GCP í‚¤ íŒŒì¼ ê²½ë¡œ í™•ì¸
ls -la config/gcp-key.json

# 2. í™˜ï¿½ï¿½ ë³€ìˆ˜ ì„¤ì •
export GOOGLE_APPLICATION_CREDENTIALS="./config/gcp-key.json"

# 3. ë˜ëŠ” ì½”ë“œì—ì„œ ëª…ì‹œì  ì„¤ì •
recorder = SIPCallRecorder(gcp_credentials_path="./config/gcp-key.json")
```

### ë¬¸ì œ 3: transcript.txtê°€ ìƒì„±ë˜ì§€ ì•ŠìŒ

**ì›ì¸**:
1. `enable_post_stt=False`
2. WAV íŒŒì¼ì´ ì—†ìŒ
3. API í˜¸ì¶œ ì‹¤íŒ¨

**í•´ê²°**:
```python
# 1. ì„¤ì • í™•ì¸
print(f"STT í™œì„±í™”: {recorder.enable_post_stt}")
print(f"STT í´ë¼ì´ì–¸íŠ¸: {recorder.stt_client}")

# 2. WAV íŒŒì¼ í™•ì¸
ls recordings/call-id/mixed.wav

# 3. ë¡œê·¸ í™•ì¸
# ì˜¤ë¥˜ ë¡œê·¸ì—ì„œ "STT transcription error" ê²€ìƒ‰
```

### ë¬¸ì œ 4: í™”ì ë¶„ë¦¬ê°€ ì •í™•í•˜ì§€ ì•ŠìŒ

**ì›ì¸**:
- ìŒì„± í’ˆì§ˆ ë‚®ìŒ
- ë‘ í™”ìì˜ ìŒì„± íŠ¹ì„±ì´ ìœ ì‚¬
- ë™ì‹œ ë°œí™”

**í•´ê²°**:
1. `enable_diarization=False`ë¡œ ì„¤ì •í•˜ì—¬ ì „ì²´ í…ìŠ¤íŠ¸ë§Œ ë°›ê¸°
2. ìŒì„± í’ˆì§ˆ ê°œì„  (ì½”ë±, ìƒ˜í”Œë ˆì´íŠ¸)
3. í›„ì²˜ë¦¬ë¡œ ìˆ˜ë™ í¸ì§‘

---

## ğŸ“ ì¶”ê°€ ê°œì„  ê°€ëŠ¥ ì‚¬í•­

### 1. ê³ ê¸‰ í™”ì ë¶„ë¦¬
```python
# 3ëª… ì´ìƒ í™”ì ì§€ì›
diarization_config=speech.SpeakerDiarizationConfig(
    enable_speaker_diarization=True,
    min_speaker_count=2,
    max_speaker_count=5  # 3~5ëª… íšŒì˜
)
```

### 2. ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° STT
```python
async def stream_stt(self, call_id: str):
    """ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° STT (ê³ ê¸‰)"""
    requests = (
        speech.StreamingRecognizeRequest(audio_content=chunk)
        for chunk in audio_stream
    )
    
    responses = self.stt_client.streaming_recognize(config, requests)
    
    for response in responses:
        # ì‹¤ì‹œê°„ ì „ì‚¬ ê²°ê³¼ ì²˜ë¦¬
        pass
```

### 3. ë‹¤êµ­ì–´ ì§€ì›
```python
# ìë™ ì–¸ì–´ ê°ì§€
config = speech.RecognitionConfig(
    language_code="ko-KR",
    alternative_language_codes=["en-US", "ja-JP"]
)
```

### 4. ì»¤ìŠ¤í…€ ë‹¨ì–´ íŒíŠ¸
```python
# íŠ¹ì • ë‹¨ì–´ ì¸ì‹ë¥  í–¥ìƒ
speech_contexts = [
    speech.SpeechContext(
        phrases=["ì˜ˆì•½", "ì·¨ì†Œ", "ë³€ê²½", "í™•ì¸"],
        boost=20  # 1-20
    )
]
```

---

## ğŸ“ ìš”ì•½

### âœ… êµ¬í˜„ ì™„ë£Œ

1. âœ… **SIPCallRecorder ê°œì„ **
   - í›„ì²˜ë¦¬ STT ë©”ì„œë“œ ì¶”ê°€
   - í™”ì ë¶„ë¦¬(diarization) êµ¬í˜„
   - transcript.txt ìë™ ìƒì„±

2. âœ… **stop_recording() í†µí•©**
   - WAV íŒŒì¼ ì €ì¥ í›„ ìë™ STT ì‹¤í–‰
   - ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ ë¸”ë¡œí‚¹ ë°©ì§€

3. âœ… **config.yaml ì„¤ì •**
   - post_processing_stt ì„¹ì…˜ ì¶”ê°€
   - ìƒì„¸ ì˜µì…˜ ì„¤ì • ê°€ëŠ¥

4. âœ… **CallManager ì—°ë™**
   - ì¼ë°˜ í†µí™” ì¢…ë£Œ ì‹œ ì§€ì‹ ì¶”ì¶œ íŠ¸ë¦¬ê±°
   - transcript.txt ê²½ë¡œ ìë™ ì „ë‹¬

5. âœ… **í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸**
   - êµ¬ì¡° í…ŒìŠ¤íŠ¸
   - ì‹¤ì œ API í…ŒìŠ¤íŠ¸

### ğŸ¯ ì‘ë™ í™•ì¸

- âœ… AI í†µí™”: STT â†’ Transcript â†’ ì§€ì‹ ì¶”ì¶œ
- âœ… **ì¼ë°˜ í†µí™”: ë…¹ìŒ â†’ í›„ì²˜ë¦¬ STT â†’ Transcript â†’ ì§€ì‹ ì¶”ì¶œ** â­ ì‹ ê·œ

### ğŸ’¡ í•µì‹¬ ì¥ì 

1. **ìë™í™”**: ëª¨ë“  í†µí™”ê°€ ìë™ìœ¼ë¡œ ì „ì‚¬ë¨
2. **ê³ í’ˆì§ˆ**: ì „ì²´ ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ì „ì‚¬
3. **ë¹„ìš© íš¨ìœ¨**: ë°°ì¹˜ ì²˜ë¦¬ë¡œ ì €ë ´
4. **ë¹„ë™ê¸°**: í†µí™” ì¢…ë£Œì— ë¸”ë¡œí‚¹ ì—†ìŒ
5. **í™”ì ë¶„ë¦¬**: ë°œì‹ ì/ì°©ì‹ ì ìë™ êµ¬ë¶„

---

**ì‘ì„±ì**: Winston (Developer)  
**ì¼ì**: 2026-01-08  
**ìƒíƒœ**: âœ… êµ¬í˜„ ì™„ë£Œ  
**ë‹¤ìŒ ë‹¨ê³„**: í”„ë¡œë•ì…˜ ë°°í¬ ë° ëª¨ë‹ˆí„°ë§

